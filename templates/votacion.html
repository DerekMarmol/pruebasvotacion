<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Votaciones: Proceso Administrativo</title>
    <style>
        /* Paleta de colores */
        :root {
        --primary-color: #2c3e50;
        --secondary-color: #e67e22;
        --accent-color: #d35400;
        --light-color: #ecf0f1;
        --dark-color: #34495e;
        }

        /* Tipografía */
        body {
        font-family: 'Montserrat', sans-serif;
        color: var(--dark-color);
        }

        h1, h2, h3 {
        font-family: 'Playfair Display', serif;
        color: var(--primary-color);
        }

        /* Encabezado */
        #titulo {
        text-align: center;
        font-size: 3rem;
        text-transform: uppercase;
        letter-spacing: 2px;
        margin-bottom: 1rem;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        .bienvenida {
        background-color: var(--secondary-color);
        color: var(--light-color);
        padding: 1rem;
        border-radius: 5px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        text-align: center;
        font-size: 1.2rem;
        }

        /* Grupos */
        #grupos-container {
        margin-top: 2rem;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 2rem;
        }

        .grupo {
        background-color: var(--light-color);
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        padding: 1.5rem;
        text-align: center;
        transition: all 0.3s ease-in-out;
        position: relative;
        overflow: hidden;
        }

        .grupo:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }

        .grupo h2 {
        font-size: 1.2rem;
        margin-bottom: 1rem;
        }

        .votar {
        background-color: var(--accent-color);
        color: var(--light-color);
        border: none;
        padding: 0.8rem 1.2rem;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.3s ease-in-out;
        font-size: 1rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        }

        .votar:hover {
        background-color: var(--secondary-color);
        }

        .votar:disabled {
        background-color: var(--dark-color);
        cursor: not-allowed;
        }

        /* Botones de administración */
        button {
        background-color: var(--primary-color);
        color: var(--light-color);
        border: none;
        padding: 0.8rem 1.2rem;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.3s ease-in-out;
        font-size: 1rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin: 1rem;
        }

        button:hover {
        background-color: var(--secondary-color);
        }

        /* Recuento de votos */
        #recuentoVotos {
        margin-top: 2rem;
        background-color: var(--light-color);
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        padding: 1.5rem;
        }

        .grupoVoto {
        background-color: var(--primary-color);
        color: var(--light-color);
        padding: 0.8rem;
        border-radius: 5px;
        margin-bottom: 0.5rem;
        }

        /* Resultado de votación centrado */
        #resultadoVotacion {
        margin: 2rem auto; /* Margen automático para centrar horizontalmente */
        max-width: 500px; /* Ajusta el ancho máximo según tus necesidades */
        background-color: var(--light-color);
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        padding: 1.5rem;
        text-align: center;
        animation: fadeIn 1s ease-in-out;
        }

        /* Animaciones */
        @keyframes fadeIn {
        from {
            opacity: 0;
        }
        to {
            opacity: 1;
        }
        }

        @keyframes slideIn {
        from {
            transform: translateY(-20px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
        }

        .bienvenida, .grupo, #recuentoVotos {
        animation: fadeIn 1s ease-in-out;
        }

        /* Distribución de grupos */
        #grupos-container {
        display: flex;
        justify-content: center;
        }

        .grupo {
        background-color: var(--light-color);
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        padding: 1.5rem;
        text-align: center;
        transition: all 0.3s ease-in-out;
        position: relative;
        overflow: hidden;
        }

        #grupos {
        display: grid;
        grid-template-columns: repeat(2, minmax(250px, 1fr));
        gap: 2rem;
        max-width: 100%;
        }

        /* Botones de votar deshabilitados */
        .votar:disabled {
        background-color: #ccc; /* Color gris claro */
        color: #666; /* Color gris oscuro */
        cursor: not-allowed;
        }

        .grupo31-container {
            display: flex;
            justify-content: center;
        }

        .grupo31 {
            background-color: var(--light-color);
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            text-align: center;
            transition: all 0.3s ease-in-out;
            position: relative;
            overflow: hidden;
        }
        

        /* Responsive */
        @media (max-width: 768px) {
        #grupos {
            grid-template-columns: repeat(1, 1fr);
        }
        }
    </style>
</head>
<body>
    <h1 id="titulo">Votaciones: Proceso Administrativo</h1>
    <div class="bienvenida"><p>Bienvenid@ a las votaciones {{ session.get('nombre', 'Invitado') }}!</p></div>
    <div id="grupos-container">
        <div id="grupos">
            <div class="grupo">
                <h2>No.1 Derek Leonel Marmol Salguero</h2>
                <button class="votar" data-grupo="1" disabled>Votar</button>
            </div>
            <div class="grupo">
                <h2>No.2 Ludin Eduardo Carranza Guerra</h2>
                <button class="votar" data-grupo="2" disabled>Votar</button>
            </div>
            <div class="grupo">
                <h2>No.3 Edgar Roberto Quiñonez Herrera</h2>
                <button class="votar" data-grupo="3" disabled>Votar</button>
            </div>
            <div class="grupo">
                <h2>No.4 Leonel Estuardo Lémus Martínez</h2>
                <button class="votar" data-grupo="4" disabled>Votar</button>
            </div>
            <div class="grupo">
                <h2>No.5 María José del Carmen Portillo López</h2>
                <button class="votar" data-grupo="5" disabled>Votar</button>
            </div>
            <div class="grupo">
                <h2>No.6 Fernando José Carranza Cabrera</h2>
                <button class="votar" data-grupo="6" disabled>Votar</button>
            </div>
            <div class="grupo">
                <h2>No.7 Astrid Mileidy Peña Polanco</h2>
                <button class="votar" data-grupo="7" disabled>Votar</button>
            </div>
            <div class="grupo">
                <h2>No.8 Ángel Alexander López Martínez</h2>
                <button class="votar" data-grupo="8" disabled>Votar</button>
            </div>
            <div class="grupo">
                <h2>No.9 Allan Enrique Recinos Castillo</h2>
                <button class="votar" data-grupo="9" disabled>Votar</button>
            </div>
            <div class="grupo">
                <h2>No.10 Luis Gustavo Ramírez Berganza</h2>
                <button class="votar" data-grupo="10" disabled>Votar</button>
            </div>
            <div class="grupo">
                <h2>No.11 Diego Alexander Contreras Duarte</h2>
                <button class="votar" data-grupo="11" disabled>Votar</button>
            </div>
            <div class="grupo">
                <h2>No.12 Ana Laura de María Oliva Cruz</h2>
                <button class="votar" data-grupo="12" disabled>Votar</button>
            </div>
            <div class="grupo">
                <h2>No.13 Brandon Fabián Morales Méléndez</h2>
                <button class="votar" data-grupo="13" disabled>Votar</button>
            </div>
            <div class="grupo">
                <h2>No.14 Yeferson Yosmar Tobar Lémus</h2>
                <button class="votar" data-grupo="14" disabled>Votar</button>
            </div>
            <div class="grupo">
                <h2>No.15 Delmy María Fajardo Borrayo</h2>
                <button class="votar" data-grupo="15" disabled>Votar</button>
            </div>
            <div class="grupo">
                <h2>No.16 Cristian Eduardo Chamo Morales</h2>
                <button class="votar" data-grupo="16" disabled>Votar</button>
            </div>
            <div class="grupo">
                <h2>No.17 Kevin Josué Orellana Arbizú</h2>
                <button class="votar" data-grupo="17" disabled>Votar</button>
            </div>
            <div class="grupo">
                <h2>No.18 Marvin Jaffet Gudiel López</h2>
                <button class="votar" data-grupo="18" disabled>Votar</button>
            </div>
            <div class="grupo">
                <h2>No.19 Alba Cristina Nájera Marroquín</h2>
                <button class="votar" data-grupo="19" disabled>Votar</button>
            </div>
            <div class="grupo">
                <h2>No.20 Daniel Alexander Ortiz Cabrera</h2>
                <button class="votar" data-grupo="20" disabled>Votar</button>
            </div>
            <div class="grupo">
                <h2>No.21 Andreina Jannin Ulloa Téllez</h2>
                <button class="votar" data-grupo="21" disabled>Votar</button>
            </div>
            <div class="grupo">
                <h2>No.22 Christian Eduardo López Lémus</h2>
                <button class="votar" data-grupo="22" disabled>Votar</button>
            </div>
            <div class="grupo">
                <h2>No.23 José Alberto Caal Cristales</h2>
                <button class="votar" data-grupo="23" disabled>Votar</button>
            </div>
            <div class="grupo">
                <h2>No.24 Jorge Danilo Ucelo Román</h2>
                <button class="votar" data-grupo="24" disabled>Votar</button>
            </div>
            <div class="grupo">
                <h2>No.25 Maddison Gabriela Sermeño Rivas</h2>
                <button class="votar" data-grupo="25" disabled>Votar</button>
            </div>
            <div class="grupo">
                <h2>No.26 Sinthia Celeste Orellana Galeano</h2>
                <button class="votar" data-grupo="26" disabled>Votar</button>
            </div>
            <div class="grupo">
                <h2>No.27 Aura Lucía Sandoval Pivaral</h2>
                <button class="votar" data-grupo="27" disabled>Votar</button>
            </div>
            <div class="grupo">
                <h2>No.28 Keily Atalia López Hernández</h2>
                <button class="votar" data-grupo="28" disabled>Votar</button>
            </div>
            <div class="grupo">
                <h2>No.29 Fredy Aníbal Cardona Montenegro</h2>
                <button class="votar" data-grupo="29" disabled>Votar</button>
            </div>
            <div class="grupo">
                <h2>No.30 Julio Alejandro Pineda Duque</h2>
                <button class="votar" data-grupo="30" disabled>Votar</button>
            </div>
            <div class="grupo31-container">
                <div class="grupo grupo31">
                    <h2>No.31 Patrick Alexander Salguero Solares</h2>
                    <button class="votar" data-grupo="31" disabled>Votar</button>
                </div>
            </div>          
        </div>
    </div>
    <div id="resultadoVotacion" style="display: none;"></div>
    <span id="es-admin-valor" style="display: none;">{{ session.get('es_admin', False) | tojson }}</span>
    <span id="correo-usuario" style="display: none;">{{ session.get('correo', '') }}</span>
    {% if session.get('es_admin', False) %}
        <button id="abrirVotacion">Abrir Votación</button>
        <button id="cerrarVotacion" style="display: none;">Cerrar Votación</button>
        <button id="reiniciarVotaciones" style="display: none;">Reiniciar Votaciones</button>
        <div id="recuentoVotos" style="display: none; max-height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; border-radius: 5px;">
            <h3 style="margin-bottom: 10px;">Recuento de Votos:</h3>
            <div id="recuentoVotosContainer">
                <!-- Aquí se añadirán los cuadros de recuento de votos dinámicamente -->
            </div>
        </div>
    {% endif %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.1/socket.io.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const socket = io();

            // Obtener el valor de es_admin desde el elemento HTML
            const esAdminValorElemento = document.getElementById('es-admin-valor');
            const esAdmin = esAdminValorElemento ? JSON.parse(esAdminValorElemento.textContent) : false;

            let votacionAbierta = false;
            let usuariosVotaron = new Set(); // Nuevo conjunto para rastrear usuarios que han votado
            const correoUsuarioElemento = document.getElementById('correo-usuario');
            const correoUsuario = correoUsuarioElemento ? correoUsuarioElemento.textContent : '';

            function toggleVotingButtons(enable) {
                const votarButtons = document.querySelectorAll('.votar');
                if (votarButtons) {
                    votarButtons.forEach(button => {
                        button.disabled = !enable;
                    });
                }
            }

            // Manejar actualizaciones de recuento de votos en tiempo real
            socket.on('recuento_votos', data => {
                votacionAbierta = true;
                actualizarRecuentoVotos(data.recuento_votos);
                toggleVotingButtons(true); // Habilitar botones de votar para todos los usuarios
            });

            // Manejar mensajes de votación cerrada en tiempo real
            socket.on('votacion_cerrada', data => {
                votacionAbierta = false;
                toggleVotingButtons(false); // Deshabilitar botones de votar para todos los usuarios
                const resultadoVotacionDiv = document.getElementById('resultadoVotacion');
                if (resultadoVotacionDiv) {
                    resultadoVotacionDiv.innerText = data.resultado;
                    resultadoVotacionDiv.style.display = 'block';
                }
                usuariosVotaron.clear(); // Limpiar el conjunto de usuarios que votaron
                // Actualizar otros elementos de la interfaz de usuario según sea necesario
            });

            // Manejar evento de votaciones reiniciadas
            socket.on('votaciones_reiniciadas', () => {
                votacionAbierta = false;
                toggleVotingButtons(false); // Deshabilitar botones de votar para todos los usuarios
                const resultadoVotacionDiv = document.getElementById('resultadoVotacion');
                if (resultadoVotacionDiv) {
                    resultadoVotacionDiv.style.display = 'none';
                }
                const recuentoVotosDiv = document.getElementById('recuentoVotos');
                if (recuentoVotosDiv) {
                    recuentoVotosDiv.style.display = 'none';
                    recuentoVotosDiv.innerHTML = ''; // Limpiar el recuento de votos
                }
                usuariosVotaron.clear(); // Limpiar el conjunto de usuarios que votaron
            });

            // Función para manejar el clic en el botón de votar
            function handleVoting(event) {
                const grupoId = parseInt(event.target.getAttribute('data-grupo')); // Convertir a entero

                // Obtener el correo del usuario actual desde el elemento HTML
                const correoUsuarioElemento = document.getElementById('correo-usuario');
                const correoUsuario = correoUsuarioElemento ? correoUsuarioElemento.textContent : '';

                // Verificar si el usuario ya ha votado
                if (usuariosVotaron.has(correoUsuario)) {
                    console.log('Ya has votado anteriormente');
                    return;
                }

                // Registrar que el usuario ha votado
                usuariosVotaron.add(correoUsuario);

                fetch('/votar', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 'grupo': grupoId })
                })
                .then(response => response.json())
                .then(data => {
                    console.log(data.resultado);
                    // Aquí puedes actualizar la interfaz de usuario con el resultado
                })
                .catch(error => console.error('Error:', error));
            }

            // Añadir el evento de clic a cada botón de votar
            const votarButtons = document.querySelectorAll('.votar');
            if (votarButtons) {
                votarButtons.forEach(button => {
                    button.addEventListener('click', handleVoting);
                });
            }

            // Actualizar y mostrar el recuento de votos
            function actualizarRecuentoVotos(recuentoVotos) {
                const recuentoVotosContainer = document.getElementById('recuentoVotosContainer');
                if (recuentoVotosContainer && recuentoVotos && typeof recuentoVotos === 'object') {
                    recuentoVotosContainer.innerHTML = ''; // Limpiar el contenido anterior

                    // Iterar sobre el objeto de recuento de votos y construir los cuadros de recuento de votos
                    for (const [grupo, votos] of Object.entries(recuentoVotos)) {
                        const recuentoVotosHTML = `
                            <div style="margin-bottom: 10px;">
                                <p>No.${grupo}: ${votos} votos</p>
                            </div>
                        `;
                        recuentoVotosContainer.insertAdjacentHTML('beforeend', recuentoVotosHTML);
                    }

                    const recuentoVotosDiv = document.getElementById('recuentoVotos');
                    if (recuentoVotosDiv) {
                        recuentoVotosDiv.style.display = 'block'; // Mostrar el recuento de votos
                    }
                } else {
                    console.error('El recuento de votos no está definido correctamente:', recuentoVotos);
                }
            }

            // Código para administradores
            if (esAdmin) {
                // Manejar la apertura de votación
                const abrirVotacionBtn = document.getElementById('abrirVotacion');
                if (abrirVotacionBtn) {
                    abrirVotacionBtn.addEventListener('click', event => {
                        fetch('/abrir_votacion', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        })
                        .then(response => response.json())
                        .then(data => {
                            console.log(data);
                            toggleVotingButtons(true); // Habilitar los botones de votar
                            abrirVotacionBtn.style.display = 'none';
                            const cerrarVotacionBtn = document.getElementById('cerrarVotacion');
                            if (cerrarVotacionBtn) {
                                cerrarVotacionBtn.style.display = 'block';
                            }
                            const reiniciarVotacionesBtn = document.getElementById('reiniciarVotaciones');
                            if (reiniciarVotacionesBtn) {
                                reiniciarVotacionesBtn.style.display = 'none';
                            }
                            actualizarRecuentoVotos(data.recuento_votos); // Actualizar y mostrar recuento de votos
                        })
                        .catch(error => console.error('Error:', error));
                    });
                } else {
                    console.log('El botón abrirVotacion no se encontró en el DOM');
                }

                // Manejar el cierre de votación
                const cerrarVotacionBtn = document.getElementById('cerrarVotacion');
                if (cerrarVotacionBtn) {
                    cerrarVotacionBtn.addEventListener('click', event => {
                        fetch('/cerrar_votacion', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        })
                        .then(response => response.json())
                        .then(data => {
                            console.log(data);
                            toggleVotingButtons(false); // Deshabilitar los botones de votar
                            const resultadoVotacionDiv = document.getElementById('resultadoVotacion');
                            if (resultadoVotacionDiv) {
                                resultadoVotacionDiv.innerText = data.resultado;
                                resultadoVotacionDiv.style.display = 'block';
                            }
                            abrirVotacionBtn.style.display = 'none';
                            cerrarVotacionBtn.style.display = 'none';
                            const reiniciarVotacionesBtn = document.getElementById('reiniciarVotaciones');
                            if (reiniciarVotacionesBtn) {
                                reiniciarVotacionesBtn.style.display = 'block';
                            }
                            actualizarRecuentoVotos(data.recuento_votos); // Actualizar y mostrar recuento de votos al cerrar la votación
                        })
                        .catch(error => console.error('Error:', error));
                    });
                } else {
                    console.log('El botón cerrarVotacion no se encontró en el DOM');
                }

                // Manejar el reinicio de votaciones
                const reiniciarVotacionesBtn = document.getElementById('reiniciarVotaciones');
                if (reiniciarVotacionesBtn) {
                    reiniciarVotacionesBtn.addEventListener('click', event => {
                        fetch('/reiniciar_votaciones', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        })
                        .then(response => response.json())
                        .then(data => {
                            console.log(data);
                            if (abrirVotacionBtn) {
                                abrirVotacionBtn.style.display = 'block';
                            }
                            if (cerrarVotacionBtn) {
                                cerrarVotacionBtn.style.display = 'none';
                            }
                            reiniciarVotacionesBtn.style.display = 'none';
                            const resultadoVotacionDiv = document.getElementById('resultadoVotacion');
                            if (resultadoVotacionDiv) {
                                resultadoVotacionDiv.style.display = 'none';
                            }
                            const recuentoVotosDiv = document.getElementById('recuentoVotos');
                            if (recuentoVotosDiv) {
                                recuentoVotosDiv.style.display = 'none'; // Ocultar el recuento de votos
                                recuentoVotosDiv.innerHTML = ''; // Limpiar el recuento de votos
                            }
                        })
                        .catch(error => console.error('Error:', error));
                    });
                } else {
                    console.log('El botón reiniciarVotaciones no se encontró en el DOM');
                }
            } // Cierre del bloque if (esAdmin)
        });
    </script>                 
</body>
</html>